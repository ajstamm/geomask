---
title: "Tutorial"
author: "Abigail Stamm"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette is designed for a user with no experience in R who just wants to run the default version of the geomasking tool, or geomasker. This manual breaks down the different parts of the program and describes what to do and what to expect using 2010 Census shapefiles for Onondaga County in New York State, which are embedded in the package. These shapefiles will be used in this manual. 

*Note: For users who wish to modify the geomasker, developer options have been written into several of the package functions. Check the functions' help pages (linked from function names) and the [Technical Notes](../doc/tech_notes.html) for more information. Users interested only in running the geomasker can ignore these links.*

# Objective

This tutorial will walk you through the following activities. You will start with a shapefile of landmark points in Onondaga County in two New York State. You will enter settings to shift these points within their Census tracts.

The results will be displayed in the log and as a map in a PDF. The new points will be saved as an ESRI shapefile and, if desired, as a Google Earth KML file so that you can import them to your preferred GIS application.


# Running the geomasker

Please note that R is case sensitive. The provided code is designed to be copy-pasted, but if you prefer to type it yourself, be aware of capitalization.

To follow this vignette, you will need appropriate shapefiles. For that purpose, the first step is to create the shapefiles using the R package tigris. The tigris package is not required to run the geomasker, so you may need to install it first.

```{r installtigris, eval = FALSE}
# install tigris if necessary



```

The code below will save two shapefiles to your working directory. To find your working directory, run `getwd()`. To change your working directory, run `setwd(your_filepath)` with the folder you want. R does recognize relative path commands like `../`.

```{r createshapefiles, eval = FALSE}
# create and save the shapefiles
ot <- tigris::tracts("NY", "Onondaga", year = 2010)
ol <- tigris::landmarks("NY", "point", year = 2015)
t <- sf::st_contains(ot, ol) |> unlist()
ol <- ol[t, ]

sf::write_sf(ot, dsn = "maps", layer = "onondaga_tracts", driver = "ESRI shapefile")
sf::write_sf(ol, dsn = "maps", layer = "onondaga_points", driver = "ESRI shapefile")

rm(ol, ot, t)
```



To run the geomasker, you only need one line of code:

> `geomask::runGMprogram()`

The steps below will walk you through the dialogs and describe the types of input expected using the shapefiles created above. 

The geomasker starts by creating initial variables and displaying a progress bar that will continually update as it runs. Its processes occur in this order:

* request information in 7 user input steps
* Shift or mask the locations
* draw a map
* save files

# User input section

This is the interactive portion of the geomasker. The steps below will walk you through what to expect from the geomasker. If any portion of this section is cancelled, the geomasker will quit. 

Do not close the progress bar before the geomasker finishes running. If you do, the geomasker will crash with this error:

> warning('Error in structure(.External(.C_dotTclObjv, objv), class = "tclObj") :  
>   [tcl] bad window path name ".113".')

## Step 1. Request an input shapefile

This step requests the location shapefile and identifier variable from the user using pop-up dialogs. In the first dialog, you can navigate to any shapefile on your computer or network. To follow the steps as shown, navigate to the "maps" folder you just created. Select the "onondaga_points" shapefile. 

```{r shppic, fig.cap = 'Dialog: Identify Location Shapefile', fig.alt = 'Dialog: Identify Location Shapefile', echo = FALSE}
# generate window for image
# uses gatpkg::locateGATshapefile()
knitr::include_graphics("images/pick_shp.png")
```

To follow the steps as shown, select "onondaga_points.shp" and click `Open` to move to the next step or click `Cancel` to end the program. 

In the second dialog, all variables in the locations shapefile with unique (non-repeated) values are listed. Select the variable you wish to use for your identifier.

```{r locidpic, fig.cap = 'Dialog: Identify location ID variable', fig.alt = 'Dialog: Identify Location ID', echo = FALSE}
# generate window for image
# uses gatpkg::locateGATshapefile()
knitr::include_graphics("images/locid_shp.png")
```

To follow the steps as shown, select "POINTID". Click `Next >` to move to the next step, `< Back` to move to the previous step, `Quit geomasker` to end the program, or `Help` to get further guidance.


## Step 2. Request boundary variable

This step requests the boundary shapefile and identifier variable from the user using pop-up dialogs. In the first dialog, you can navigate to any shapefile on your computer or network. To follow the steps as shown, navigate to the "maps" folder you just created. Select the "onondaga_tracts" shapefile. 

```{r boundpic, fig.cap = 'Dialog: Identify Boundary Shapefile', fig.alt = 'Dialog: Identify Boundary Shapefile', echo = FALSE}
# generate window for image
# uses gatpkg::locateGATshapefile()
knitr::include_graphics("images/pick_shp.png")
```


To follow the steps as shown, select "onondaga_tracts.shp" and click `Open` to move to the next step or click `Cancel` to end the program. 

In the second dialog, all variables in the boundary shapefile with unique (non-repeated) values are listed. Select the variable you wish to use for your identifier.

```{r boundidpic, fig.cap = 'Dialog: Identify boundary ID variable', fig.alt = 'Dialog: Identify Boundary ID', echo = FALSE}
# generate window for image
# uses gatpkg::locateGATshapefile()
knitr::include_graphics("images/boundid_shp.png")
```

To follow the steps as shown, select "GEOID10". Click `Next >` to move to the next step, `< Back` to move to the previous step, `Quit geomasker` to end the program, or `Help` to get further guidance.



## Step 3. Request distances

This step requests the desired minimum and maximum values and their unit of measure from the user using a pop-up dialog. In this dialog, select the unit of measure for the distance from the drop-down menu. Enter the minimum and maximum distances you would like the masked point to be moved.


```{r distpick, fig.cap = 'Dialog: Select Distances', fig.alt = 'Dialog: Select Distances', echo = FALSE}
# generate window for image
# geomask::selectGMdistance(step = 3, min = 100, max = 500, unit = "",
#                           quitopt = "Quit geomasker")
knitr::include_graphics("images/pick_distances.png")
```

To follow the steps as shown, select "meters" for unit of distance, change the minimum value to "1,000", and change the maximum value to "5,000". Click `Next >` to move to the next step, `< Back` to move to the previous step, `Quit geomasker` to end the program, or `Help` to get further guidance.




## Step 9. Request whether to save KML file

This step asks whether the user wants to save a KML file using a pop-up dialog.

```{r kmlpic, fig.cap = 'Dialog: Save KML', fig.alt = 'Dialog: Save KML', echo = FALSE}
# generate window for image
# gatpkg::saveGATkml(step = 9)
knitr::include_graphics("images/pick_kml.png")
```

To follow the steps as shown, select "No". Click `Next >` to move to the next step, `< Back` to move to the previous step, `Quit geomasker` to end the program, or `Help` to get further guidance.

## Step 5. Request where to save shapefile

This step asks the user where to save the shapefile using a pop-up dialog. In this dialog, you can navigate to any folder on your computer or network. 

```{r savepic, fig.cap = 'Dialog: Save File', fig.alt = 'Dialog: Save File', echo = FALSE}
# generate window for image
# gatpkg::saveGATfiles()
knitr::include_graphics("images/pick_save.png")
```

To follow the steps as shown, navigate to your documents folder. Enter "geomasked_points". Click "Save" to move to the next step or click "Cancel" to end the program. 


## Step 6. Request settings confirmation


This step requests confirmation of all settings from the user using a pop-up dialog. In this dialog, you can select a step to modify or move on. To modify steps, select the first step you want to modify from top to bottom. After each modification, you will return to this dialog to select the next step. 

```{r confirmpic, fig.cap = 'Dialog: Confirm Settings', fig.alt = 'Dialog: Confirm Settings', echo = FALSE}
knitr::include_graphics("images/pick_confirm.png")
```

If you choose to change something, select the relevant item from the drop-down menu and click `Confirm`. To cancel, click `Quit`. Click `Help` to get further guidance. To follow the steps as shown, select "None" and click `Confirm`.


# Shapefile processing section

At this point, if the user has not cancelled the program, the shapefile processing begins.


## Step 7: Calculate masked points

This is the only step in this section. This portion of the program is found in the function `calculateGMpoints()`. Because this step can take a while, a separate progress bar tracks its progress.

Buffers are drawn around each point and rings are created by subtracting the inner buffer (radius = minimum value) from the outer buffer (radius = maximum value). These buffers are intersected with the boundary file. Only the portion of each ring that intersects with its location's corresponding tract is kept. The masked point is selected randomly from the masked area. 

# Mapping section

This section contains the map created by the program. 

## Step 8. Map comparison of old and new locations


This map is a comparison of the original and geomasked locations. In this map, the original and shifted points are overlaid on top of the boundary map so you can see how the locations shifted. This portion of the program is found in the function `plotGMcompare()`. 

```{r mapca, fig.show = "hold", out.width = '90%', fig.cap = 'Map: Compare original and shifted locations', echo = FALSE}
knitr::include_graphics("images/map_compare.png")
```

*Note:* R package documentation allows you to view images, but not link to them. For the map, view a larger image by right clicking on the map and selecting "Open image in new tab." 


----

> start here - 
> need to convert to geomasker below this point


# File saving section

This section contains the file saving steps. 

## Step 21. Save maps and settings

```{r pbmaps, out.width = '60%', fig.cap = 'Progress Bar: Save a PDF of the maps', echo = FALSE}
knitr::include_graphics("images/pb_savemaps.png")
```

In this section, all maps are saved to a PDF file, with one map per page, in the same folder as the aggregated shapefile. The same save filename is used with "plots" at the end.

An Rdata file is also saved. This file includes all settings in R format, which can be opened in R or run through GAT a second time. If you want to use the Rdata file to re-run GAT, use this code and change `myfilepath` to the location and name of your Rdata file:

> `myfilepath <- "C:/users/ajs/mygatfilesettings.Rdata"`  
> `gatpkg::runGATprogram(settings = myfilepath)`


File saved to the save folder if you followed the vignette:

- hftown_agg6k15k_popwtplots.pdf (containing 5 maps)
- hftown_agg6k15k_popwtsettings.Rdata



## Step 22. Save original shapefile

```{r pbold, out.width = '60%', fig.cap = 'Progress Bar: Save the Original Shapefile', echo = FALSE}
knitr::include_graphics("images/pb_saveold.png")
```

The purpose of saving this shapefile is to provide a key/crosswalk (GATid) identifying which aggregated area each original area fell inside when aggregated. The GATflag variable flags areas that were excluded from aggregation or generated warnings in the log:

- *value = 0:* no flag
- *value = 1:* area excluded based on exclusion criteria
- *value = 5:* area excluded because value of aggregation variable exceeded maximum value

The original shapefile is saved with the following changes:

- It is renamed to match the save filename you selected with "in" at the end and saved in the same folder as the aggregated shapefile.
- The variables GATid and GATflag are appended to its dataframe.

Files saved to the save folder if you followed the vignette:

- hftown_agg6k15k_popwtin.dbf 
- hftown_agg6k15k_popwtin.prj 
- hftown_agg6k15k_popwtin.shp 
- hftown_agg6k15k_popwtin.shx 

## Step 23. Save aggregated shapefile

```{r pbnew, out.width = '60%', fig.cap = 'Progress Bar: Save the Aggregated Shapefile', echo = FALSE}
knitr::include_graphics("images/pb_savenew.png")
```

In this section, the aggregated shapefile is saved. It includes all of the variables in the original shapefile with these changes:

- For categorical variables, the first option was selected for each merge.
- For numeric variables, the values were summed unless the variables represented latitude or longitude (or x and y), in which case they were averaged.

Additional variables created as part of the aggregation process and included in the shapefile's database:

- **GATx:** longitude of area centroid (geographic unless population weighting was selected)
- **GATy:** latitude of area centroid (geographic unless population weighting was selected)
- **GATcratio:** compactness ratio for the area
- **GATnumIDs:** The number of original areas that were merged into each aggregated area
- **GATflag:** flag of areas that were excluded from aggregation or generated warnings in the log
    - *value = 0:* no flag
    - *value = 1:* area excluded based on exclusion criteria
    - *value = 5:* area excluded because value of aggregation variable exceeded maximum value
    - *value = 10:* value of area's aggregation variable is below minimum value, but no other areas are eligible for further aggregation

Files saved to the save folder if you followed the vignette:

- hftown_agg6k15k_popwt.dbf 
- hftown_agg6k15k_popwt.prj 
- hftown_agg6k15k_popwt.shp 
- hftown_agg6k15k_popwt.shx 


## Step 24. Save KML file

```{r pbkml, out.width = '60%', fig.cap = 'Progress Bar: Save the KML File', echo = FALSE}
knitr::include_graphics("images/pb_savekml.png")
```

In this step, nothing happens if you are following the vignette and selected no when asked if you wanted to save a KML file. If you had selected yes, a KML file would be created in this step that could then be opened in Google Earth. 

Files saved to the save folder, if "Yes" was selected in Step 9:

- hftown_agg6k15k_popwt.kml 


## Step 25. Save log

```{r pblog, out.width = '60%', fig.cap = 'Progress Bar: Save the Log of Your Run', echo = FALSE}
knitr::include_graphics("images/pb_log.png")
```

In this step, a text file is saved that includes all of your settings, basic information on data distributions for the aggregation variable(s), and warnings regarding possible issues with the aggregation. 


Files saved to the save folder if you followed the vignette:

- hftown_agg6k15k_popwt.log


# GAT is finished, now what?

## Where to find your files

All files are saved to the save folder you selected. The log file contains a partial list of files created. The R console will display a full list of all files created and their location when the aggregation is complete, which will look something like this:

> The following files have been written to the folder  
> C:/Users/ajs11/Documents/GAT:  
>   hftown_agg6k15k_popwt.dbf  
>   hftown_agg6k15k_popwt.prj  
>   hftown_agg6k15k_popwt.shp  
>   hftown_agg6k15k_popwt.shx  
>   hftown_agg6k15k_popwtin.dbf  
>   hftown_agg6k15k_popwtin.prj  
>   hftown_agg6k15k_popwtin.shp   
>   hftown_agg6k15k_popwtin.shx  
>   hftown_agg6k15k_popwtplots.pdf  
>   hftown_agg6k15k_popwt.log  
>   hftown_agg6k15k_popwtsettings.Rdata  
> 
> See the log file for more details.


## How to use your files

- **Shapefiles (\*.shp):** Open in ArcGIS, QGIS, or similar GIS software. 
- **KML file:** Open in Google Earth desktop or online.
- **PDF file:** Open in any PDF reader.
- **Log file:** Open in any text editor, such as Notepad++.
- **R data file (\*.Rdata):** Open in R using the format `load("C:/filepath/settings.Rdata")`.
